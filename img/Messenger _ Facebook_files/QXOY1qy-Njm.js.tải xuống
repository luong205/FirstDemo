;/*FB_PKG_DELIM*/

__d("RestoreConcurrencyManager",["BrowserLockManager","FBLogger","LockManager","MWBroadcastChannel","Promise","ReStoreNameUtils","RunComet","WAPromiseDelays","WAResolvable","asyncToGeneratorRuntime","cr:4220","err","getErrorSafe","gkx","promiseDone","recoverableViolation","setInterval","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h=typeof window!=="undefined"?window:self;function i(a,d,e,f){f===void 0&&(f=!1);return new(b("Promise"))(function(g,h){e!=null?c("promiseDone")(c("BrowserLockManager").request(a,{signal:e},b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{yield d()}finally{g()}})),function(a){},function(a){return c("gkx")("6118")?h(a):{}}):c("promiseDone")(c("BrowserLockManager").request(a,{steal:f},b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{yield d()}finally{g()}})))})}var j=function(){function a(a){this.$3="released",this.$2=a,this.$4=new(d("WAResolvable").Resolvable)()}var e=a.prototype;e.request=function(a,e,f,g){var h=this;e===void 0&&(e=!1);f===void 0&&(f=!1);if(this.$3!=="released"){var i="Tried to request lock from invalid state: "+this.$3;c("recoverableViolation")(i,"messenger_web_product");return b("Promise").reject(i)}var j=g!=null?{signal:g}:{};this.$3="waiting";return new(b("Promise"))(function(b,g){return c("BrowserLockManager").request(h.$2,babelHelpers["extends"]({ifAvailable:e,mode:a,steal:f},j),function(a){b(a);if(a==null){h.cleanupOrRelease();return}h.$3="acquired";h.$1=a;h.$4.resolve(a);h.$5=new(d("WAResolvable").Resolvable)();return h.$5.promise})["catch"](function(a){h.cleanupOrRelease(),g(a)})})};e.cleanupOrRelease=function(a){var b;a===void 0&&(a=!1);(b=this.$5)==null?void 0:b.resolve();this.$1=null;a?this.$3="cleared":(this.$3="released",this.$4.resolveWasCalled()&&(this.$4=new(d("WAResolvable").Resolvable)()))};e.waitForLock=function(){return this.$4.promise};e.getMode=function(){var a;return(a=this.$1)==null?void 0:a.mode};e.getState=function(){return this.$3};return a}();a=function(){function a(a){var e=this,f=a.onLockAcquired;a=a.onLockReleased;this.broadcastChannel=d("MWBroadcastChannel").MWBroadcastChannel(d("ReStoreNameUtils").restoreConcurrencyBroadcastChannelName);this.workQueue=[];this.highPriWorkQueue=[];this.pendingFlushes=b("Promise").resolve();this.pendingFlushCount=0;this.restoreConcurrencyManagerHiddenLock=b("cr:4220")==null?void 0:b("cr:4220")();this.upgradeInterval=c("setInterval")(function(){e.attemptLockUpgrade()},6e4);if(c("BrowserLockManager")==null)throw c("err")("Trying to run ConcurrencyManager without native LockManager!");this.onLockAcquired=f;this.onLockReleased=a;this.executionQueue=this.requestLock(new j(d("ReStoreNameUtils").reStoreCMLockName));this.broadcastChannel.addEventListener("message",function(a){switch(a.data){case"releaseLock":e.onReleaseLockRequest();break;case"tabUnloaded":e.attemptLockUpgrade();h.setTimeout(function(){return e.attemptLockUpgrade()},2e3);break}});d("RunComet").onBeforeUnload(function(){return e.onBeforeUnload()},!1)}var e=a.prototype;e.onBeforeUnload=function(){try{h.clearInterval(this.upgradeInterval),this.broadcastChannel.postMessage("tabUnloaded"),this.broadcastChannel.close()}catch(a){c("FBLogger")("mpf_web_foundations").catching(a).mustfix("Error releasing lock on unload.")}};e.enqueueWork=function(a,d){var e=this;d===void 0&&(d="normal");switch(d){case"high":this.highPriWorkQueue.push(a);break;case"normal":this.workQueue.push(a);break}return this.executionQueue=this.executionQueue.then(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.getState()==="cleared")return a;if(a.getState()!=="acquired"||a.getMode()==null)throw c("unrecoverableViolation")("Executing locked code without a lock","messenger_web_product");try{var b;b=(b=e.highPriWorkQueue.shift())!=null?b:e.workQueue.shift();return yield b(a)}catch(b){a.cleanupOrRelease();throw c("unrecoverableViolation")("Unhandled error during transaction","messenger_web_product",{error:c("getErrorSafe")(b)})}});return function(b){return a.apply(this,arguments)}}())};e.requestLock=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var e=this;this.restoreConcurrencyManagerHiddenLock&&this.restoreConcurrencyManagerHiddenLock.hidden&&(yield this.restoreConcurrencyManagerHiddenLock.hidden);if((b==null||b===d("LockManager").LockMode.Exclusive)&&(yield a.request(d("LockManager").LockMode.Exclusive,!0))!=null){try{yield this.onLockAcquired()}catch(b){a.cleanupOrRelease();throw c("unrecoverableViolation")("Error occurred during onLockAcquired","messenger_web_product",{error:c("getErrorSafe")(b)})}return a}var f=c("gkx")("9005")?new AbortController():void 0;b=k("[CM] Timeout broadcastChannel",function(){c("gkx")("9005")?f==null?void 0:f.abort():e.broadcastChannel.postMessage("releaseLock")});this.broadcastChannel.postMessage("releaseLock");try{if((yield a.request(d("LockManager").LockMode.Shared_NOT_IMPLEMENTED,!1,!1,f==null?void 0:f.signal))!=null){h.clearTimeout(b);return a}}catch(b){if(b.name==="AbortError"&&c("gkx")("9005")){c("FBLogger")("messenger_web_product").info("[CMPDB] Main lock timed out, forcing lock with stealing.");yield a.request(d("LockManager").LockMode.Exclusive,!1,!0);return this.releaseAndReacquireLock(a)}else throw b}throw c("unrecoverableViolation")("Reached unreachable code in MainLock acquisition","messenger_web_product")});function e(b,c){return a.apply(this,arguments)}return e}();e.attemptLockUpgrade=function(){var a=this;c("promiseDone")(this.enqueueWork(function(){var e=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){if(b.getMode()!==d("LockManager").LockMode.Shared_NOT_IMPLEMENTED)return b;var e=(yield c("BrowserLockManager").query());return e.held.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreCMLockName}).length+e.pending.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreCMLockName}).length>1?b:a.releaseAndReacquireLock(b)});return function(a){return e.apply(this,arguments)}}()))};e.onReleaseLockRequest=function(){var a=this;c("promiseDone")(this.enqueueWork(function(e){if(e.getMode()!==d("LockManager").LockMode.Exclusive)return b("Promise").resolve(e);var f=c("gkx")("6118")?d("LockManager").LockMode.Shared_NOT_IMPLEMENTED:void 0;return a.releaseAndReacquireLock(e,f)},"high"),function(){},function(a){c("FBLogger")("messenger_web_product").catching(a).mustfix("Encountered error handling CM lock release request")})};e.release=function(){c("promiseDone")(this.executionQueue.then(function(a){a.cleanupOrRelease(!0)}))};e.$1=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{yield this.pendingFlushes,this.pendingFlushCount!==0&&c("recoverableViolation")("Unexpected pending flushes in RestoreConcurrencyManager","messenger_web_product")}catch(a){c("recoverableViolation")("Waiting for failed flush queue, continuing","messenger_web_product",{error:a})}});function d(){return a.apply(this,arguments)}return d}();e.releaseAndReacquireLock=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){yield this.$1();a.cleanupOrRelease();yield this.onLockReleased();yield new(b("Promise"))(function(a){return h.setTimeout(a,0)});return this.requestLock(new j(d("ReStoreNameUtils").reStoreCMLockName),c)});function c(b,c){return a.apply(this,arguments)}return c}();e.queueFlush=function(a){var b=this;this.pendingFlushCount++;this.pendingFlushes=this.pendingFlushes.then(a).then(function(){b.pendingFlushCount--})};e.runExclusively=function(a){var e=this;return new(b("Promise"))(function(f,g){var j=function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{f(yield a())}catch(a){g(a)}});return function(){return c.apply(this,arguments)}}();c("promiseDone")(e.enqueueWork(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){if(a.getMode()===d("LockManager").LockMode.Exclusive)yield j();else{var f=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{h.clearTimeout(m),yield e.onLockAcquired(),yield j(),yield e.$1(),yield e.onLockReleased()}catch(a){g(a)}});return function(){return a.apply(this,arguments)}}(),l=c("gkx")("9005")?new AbortController():void 0,m=k("[CM] Timeout runExclusively",function(){c("gkx")("9005")&&(l==null?void 0:l.abort())});try{yield i(d("ReStoreNameUtils").reStoreDBLockName,f,l==null?void 0:l.signal)}catch(a){if(a.name==="AbortError"&&c("gkx")("9005"))yield i(d("ReStoreNameUtils").reStoreDBLockName,f,void 0,!0);else throw a}}return a});return function(b){return a.apply(this,arguments)}}())["catch"](function(a){return g(a)}))})};return a}();function k(a,e){return h.setTimeout(b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var b=(yield d("WAPromiseDelays").withTimeout(l(),2e3,function(){return{}})),f=b.mainHeldExclusive,g=b.mainHeldShared,h=b.mainPendingExclusive,i=b.mainPendingShared,j=b.secondaryHeld;b=b.secondaryPending;e==null?void 0:e();c("FBLogger")("messenger_web_product").mustfix(a+". State: %s, %s, %s, %s, %s, %s",f,g,h,i,j,b)}),2e4)}function l(){return m.apply(this,arguments)}function m(){m=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield c("BrowserLockManager").query()),b=a.held.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreCMLockName&&a.mode===d("LockManager").LockMode.Exclusive}).length,e=a.held.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreCMLockName&&a.mode===d("LockManager").LockMode.Shared_NOT_IMPLEMENTED}).length,f=a.pending.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreCMLockName&&a.mode===d("LockManager").LockMode.Exclusive}).length,g=a.pending.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreCMLockName&&a.mode===d("LockManager").LockMode.Shared_NOT_IMPLEMENTED}).length,h=a.held.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreDBLockName}).length;a=a.pending.filter(function(a){return a.name===d("ReStoreNameUtils").reStoreDBLockName}).length;return{mainHeldExclusive:b,mainHeldShared:e,mainPendingExclusive:f,mainPendingShared:g,secondaryHeld:h,secondaryPending:a}});return m.apply(this,arguments)}g.RestoreConcurrencyManager=a}),98);
__d("LSInMemoryTables",[],(function(a,b,c,d,e,f){"use strict";a="community_members";b="community_members_ranges_v2__generated";c=new Set([a,b]);d=new Set([a,b]);f.all=c;f.onActiveTab=d}),66);
__d("createReStoreEphemeralPersistenceForTables",["FBLogger","LSInMemoryTables","createReStoreEphemeralPersistence"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=c("createReStoreEphemeralPersistence")(),b=new Set([].concat(Array.from(d("LSInMemoryTables").onActiveTab)));return babelHelpers["extends"]({},a,{logError:function(a,b,d,e){if(d==="dbCorruption"){throw c("FBLogger")("messenger_web_product").mustfixThrow("Got unexpected undefined in edb for tables, mode: %s, table: %s, id: %s, deletedInThisTxn: %s",b,a,(d=e==null?void 0:e.id)!=null?d:"",(b=e==null?void 0:e.deletedInThisTxn)!=null?b:"")}},shouldApplySync:function(a,c){return a==="notifyInMemoryTable"&&b.has(c)},shouldSync:function(a,c){return a==="notifyInMemoryTable"&&b.has(c)}})}g["default"]=a}),98);
__d("MWLSIndexedDBConfigStore",["gkx","justknobx","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h="name";d="main";e="dbCorruption";f=c("gkx")("4463");var i=c("justknobx")._("347");function j(a){a=a.objectStoreNames;return a.contains("_db_config")}function a(){return 7}var k=babelHelpers["extends"]({fullColumnNames:!0,localVersion:i,lockVersion:a(),name:d,reStoreVaulting:f},c("gkx")("9005")?{lockStealing:!0}:{});function b(a,b){b===void 0&&(b={});if(j(a))return;a=a.createObjectStore("_db_config",{autoIncrement:!0,keyPath:h});a.createIndex(h,h,{unique:!0});b=babelHelpers["extends"]({},k,b);a.add(b);a.put({name:"epoch",value:c("uuidv4")()})}g.dbConfigKey=d;g.dbCorruptionFailuresKey=e;g.currentConfig=k;g.createDbConfig=b}),98);
__d("MessengerLocksManagerFallback",["MWLocalStorageErrorHandler","WebStorageLockManager"],(function(a,b,c,d,e,f,g){"use strict";function a(a){return d("WebStorageLockManager").make(a,{onQuotaExceeded:d("MWLocalStorageErrorHandler").onQuotaExceeded})}g.make=a}),98);
__d("LSPlatformLockState",["$InternalEnum"],(function(a,b,c,d,e,f){"use strict";a=b("$InternalEnum")({Waiting:"waiting",Acquired:"acquired",Cleaning:"cleaning",Canceled:"canceled"});f.LockState=a}),66);
__d("saveHandler",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c={};a.set(c,b);return function(){a["delete"](c)}}f["default"]=a}),66);
__d("LSPlatformSyncLock",["BrowserLockManager","FBLogger","LSPlatformErrorChannel","LSPlatformLockState","LSPlatformLsInitLog","MWBroadcastChannel","MessengerLocksManagerFallback","MessengerLogHistory","Promise","ReStoreNameUtils","Run","asyncToGeneratorRuntime","clearTimeout","emptyFunction","gkx","pageID","promiseDone","saveHandler","setTimeout","unrecoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MessengerLogHistory").getInstance("client_init"),i=typeof window!=="undefined"?window:self,j="iwantlock";function k(a,e){a===void 0&&(a=i);e===void 0&&(e=function(){return document.hasFocus()});var f=new Map(),g=new Map(),k=d("LSPlatformLockState").LockState.Waiting,l=c("emptyFunction"),m,n=c("gkx")("3890")?d("MWBroadcastChannel").MWBroadcastChannel(d("ReStoreNameUtils").lsPlatformLockBroadcastChannelName):void 0,o=function(){m!=null&&c("clearTimeout")(m);if(k===d("LSPlatformLockState").LockState.Canceled||k===d("LSPlatformLockState").LockState.Acquired)return;m=c("setTimeout")(function(){e()&&k!==d("LSPlatformLockState").LockState.Acquired&&(h.debug("tab has focus and wants to acquire sync lock"),n==null?void 0:n.postMessage(j))},3e4)};function p(){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){h.debug("Sync lock acquired"),k=d("LSPlatformLockState").LockState.Acquired,yield b("Promise").all(Array.from(f.values()).map(function(a){return a()}))});return q.apply(this,arguments)}function r(){k=d("LSPlatformLockState").LockState.Cleaning,l=c("emptyFunction"),g.forEach(function(a){return a()})}function s(){var b=new AbortController(),f=d("LSPlatformErrorChannel").subscribe(function(e){h.debug("syncLock aborted due to "+e.name),c("FBLogger")("messenger_web_product").info("SyncLock aborted due to %s",e.name),l(),b.abort(),k=d("LSPlatformLockState").LockState.Canceled,n==null?void 0:n.removeEventListener("message",g),a.removeEventListener("focus",o),f()}),g=function a(g){if(g==null||g.data==null||g.data!==j||e())return;h.debug("got message from other tab to abort request to sync lock");l();b.abort();f();n==null?void 0:n.removeEventListener("message",a);k=d("LSPlatformLockState").LockState.Waiting;c("promiseDone")(t())};n==null?void 0:n.addEventListener("message",g);return b}function t(){return u.apply(this,arguments)}function u(){u=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a,e=(a=c("BrowserLockManager"))!=null?a:d("MessengerLocksManagerFallback").make(c("pageID"));if(e){k=d("LSPlatformLockState").LockState.Waiting;d("LSPlatformLsInitLog").addPoint("sync_lock_start");h.debug("Sync lock requested if available");yield new(b("Promise"))(function(a){return e.request(d("ReStoreNameUtils").lsPlatformLockName,{ifAvailable:!0},function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(c){if(c==null){h.debug("Attempted to acquire sync lock but it already taken");d("LSPlatformLsInitLog").addPoint("sync_lock_unavailable");a();return}h.debug("Attempted to acquire sync lock and suceeded");yield p();d("LSPlatformLsInitLog").addPoint("sync_lock_acquired");a();return new(b("Promise"))(function(a){l=function(){h.debug("Releasing sync lock"),r(),a()}})});return function(a){return c.apply(this,arguments)}}())});a=s();k!==d("LSPlatformLockState").LockState.Acquired&&(h.debug("Sync lock requested and will wait"),d("LSPlatformLsInitLog").addPoint("sync_lock_requests_again"),c("promiseDone")(e.request(d("ReStoreNameUtils").lsPlatformLockName,{signal:a.signal},function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){h.debug("Previous attempt to get sync lock failed, getting in queue for when/if it becomes available");yield p();return new(b("Promise"))(function(a){l=function(){h.debug("Releasing sync lock"),r(),a()}})});return function(b){return a.apply(this,arguments)}}()),function(a){},function(a){if((a==null?void 0:a.name)==="AbortError")h.debug("Aborting attempt to acquire sync lock");else{d("LSPlatformLsInitLog").addPoint("sync_lock_request_failure");throw a}}))}else{d("LSPlatformLsInitLog").addPoint("sync_lock_end_failure");throw c("unrecoverableViolation")("No lock manager inited","messenger_web_product")}});return u.apply(this,arguments)}n!=null&&(a.addEventListener("focus",o),o());d("Run").onBeforeUnload(function(){l()},!1);return{_getStateInternal:function(){return k},hasLock:function(){return k===d("LSPlatformLockState").LockState.Acquired},onAcquired:function(a){return c("saveHandler")(f,a)},onLost:function(a){return c("saveHandler")(g,a)},onLostOnce:function(a){var b=c("saveHandler")(g,function(){a(),b()})},release:function(){l()},requestLock:t}}var l=null;function a(){l==null&&(l=k());return l}function e(){l!=null&&l.release()}g.init=k;g.use=a;g.releaseIfExist=e}),98);
__d("ReStoreDbVersionChange",["ClientConsistencyEventEmitter","CurrentUser","LSPlatformSyncLock"],(function(a,b,c,d,e,f,g){"use strict";var h="LS DB changed version",i="ReStoreDbVersionChange";a=function(a){babelHelpers.inheritsLoose(b,a);function b(){var b,e=h;b=a.call(this,e)||this;b.message=e;b.name=i;d("LSPlatformSyncLock").releaseIfExist();switch(c("CurrentUser").getAppID()){case 772021112871879:c("ClientConsistencyEventEmitter").emit("hardRefresh","pdb_mismatch");break;default:c("ClientConsistencyEventEmitter").emit("softRefresh","pdb_mismatch")}return b}return b}(babelHelpers.wrapNativeSuper(Error));g.ERROR_NAME=i;g.ReStoreDbVersionChange=a}),98);
__d("createReStoreIndexedDbPersistence",["BrowserLockManager","CurrentMessengerUser","Deferred","ExecutionEnvironment","FBLogger","LSPlatformErrorChannel","LSPlatformLsInitLog","MAWLSDBEncryption","MWBroadcastChannel","MWLSIndexedDBConfigStore","MessengerLocksManagerFallback","MessengerLogHistory","ReStoreDbVersionChange","ReStorePersistence","cr:4038","deepEquals","gkx","nullthrows","pageID","promiseDone","qex","recoverableViolation","unrecoverableViolation","uuidv4"],(function(a,b,c,d,e,f,g){"use strict";var h=d("CurrentMessengerUser").getIDorEIMU(),i=d("MessengerLogHistory").getInstance("db_init"),j=new Set(["_db_config"]);function k(a,b){if(a!=null)if(a instanceof ArrayBuffer)return d("MAWLSDBEncryption").decryptLSDBObj(a,b);else throw c("unrecoverableViolation")("Expected encrypted string","messenger_web_product");else return a}function l(a,b){if(a!=null)return d("MAWLSDBEncryption").encryptLSDBObj(a,b);else return a}function m(a){return new self.Promise(function(b,c){a.onsuccess=function(a){b(a.target.result)},a.onerror=function(a){c(a)}})}function n(a){for(a of a.values())if(a.size!==0)return!1;return!0}function o(a,b){var c=[];a=new Set(a);for(var d of a)b.objectStoreNames.contains(d)||c.push(d);d=[];for(var e=0;e<b.objectStoreNames.length;e++){var f=b.objectStoreNames[e];!a.has(f)&&!j.has(f)&&d.push(f)}if(c.length!==0||d.length!==0)return[c,d]}function p(a,b){if(b==null){i.debug("Schema doesn't have changes to apply");return}i.debug("Schema has changes to apply");var c=b[0];b=b[1];c.forEach(function(b){a.objectStoreNames.contains(b)||a.createObjectStore(b,{autoIncrement:!0})});b.forEach(function(b){a.objectStoreNames.contains(b)&&a.deleteObjectStore(b)})}function q(a,b,e,f){function g(a){e(a.target),i.debug("DB onversionchange TABID="+c("pageID")),c("FBLogger")("messenger_browser_clients").info("[pdb] onversionchange inWorker=%s",String(c("ExecutionEnvironment").isInWorker)),d("LSPlatformLsInitLog").fail("version_change"),d("LSPlatformErrorChannel").emit(new(d("ReStoreDbVersionChange").ReStoreDbVersionChange)())}return new Promise(function(e,h){var i=indexedDB.open(a,f);i.onupgradeneeded=function(a){a=a.target;var c=a.result;a=a.transaction;b(c,a)};i.onerror=function(a){d("LSPlatformLsInitLog").fail("failed_to_open_pdb"),h(c("unrecoverableViolation")("Failed to open db","messenger_web_product",{error:a}))};i.onsuccess=function(a){a=a.target.result;a.addEventListener("versionchange",g);e(a)}})}function r(a){return m(a.objectStore("_db_config").get(d("MWLSIndexedDBConfigStore").dbCorruptionFailuresKey))}async function s(a,b,d){a=a.objectStore(b);if(!("getAll"in a)||!("getAllKeys"in a))return new Map();var e=await m(a.getAllKeys());e=e.length>d?e[e.length-d]:void 0;e=e!=null?IDBKeyRange.lowerBound(e,!1):void 0;a=await Promise.all([m(a.getAllKeys(e,d)),m(a.getAll(e,d))]);e=a[0];d=a[1];if(e.length!==d.length){c("recoverableViolation")("Error pre-caching "+b+" IDB table","messenger_web_product");return new Map()}a=new Map();for(var f=0;f<e.length;++f)a.set(e[f],k(d[f],b));return a}async function t(a,b){var d,e=(d=c("qex")._("338"))!=null?d:100;try{d=Array.from(a.objectStoreNames).filter(function(a){return!a.startsWith("_")});var f=a.transaction([].concat(d),"readonly");await Promise.all(d.map(function(a){return s(f,a,e).then(function(c){return b.set(a,c)})}))}catch(a){c("recoverableViolation")("Error initting ReStore cache","messenger_web_product",{error:a}),b.clear()}return a}async function u(a,b,e,f){e===void 0&&(e={});function g(a){d("MWLSIndexedDBConfigStore").createDbConfig(a,e);for(var c of b)a.createObjectStore(c,{autoIncrement:!0})}d("LSPlatformLsInitLog").addPoint("idb_open_start");var h=await q(a,g,f);d("LSPlatformLsInitLog").addPoint("idb_open_end");var j=h.transaction("_db_config","readwrite");j=await Promise.all([m(j.objectStore("_db_config").get(d("MWLSIndexedDBConfigStore").dbConfigKey)),r(j).then(function(a){return(a=a==null?void 0:a.value)!=null?a:0})]);var k=j[0];j=j[1];var l=j>0;l&&(c("FBLogger")("messenger_browser_clients").info("[pdb] opening corrupted db failures=%s inWorker=%s",String(j),String(c("ExecutionEnvironment").isInWorker)),i.debug("DB corrupted, deleting db"));j=!c("deepEquals")(babelHelpers.extends({},d("MWLSIndexedDBConfigStore").currentConfig,e),k);j&&i.debug("DB config mismatch, deleting db");d("LSPlatformLsInitLog").addAnnotations({bool:{configMismatch:j,dbCorruptionOccured:l}});if(j||l)h.close(),d("LSPlatformLsInitLog").addPoint("delete_db_start"),await m(indexedDB.deleteDatabase(a)),d("LSPlatformLsInitLog").addPoint("delete_db_end"),d("LSPlatformLsInitLog").addPoint("re_open_db_start"),h=await q(a,g,f),d("LSPlatformLsInitLog").addPoint("re_open_db_end");else{var n=o(b,h);n!=null&&(i.debug("Schema mismatch, bumping db version"),h.close(),d("LSPlatformLsInitLog").addPoint("schema_mismatch_bump_version_start"),h=await q(a,function(a){return p(a,n)},f,h.version+1),d("LSPlatformLsInitLog").addPoint("schema_mismatch_bump_version_end"))}return h}function a(a,e){var f="dbLock-"+h+"-"+a,g=!0,j,o=[],p=!1,s=!1,v=b("cr:4038")!=null&&c("BrowserLockManager")!=null?new(b("cr:4038").RestoreConcurrencyManager)({onLockAcquired:async function(){if(!g)return;var a=await F();y!==a&&y!=null&&(z.clear(),c("FBLogger")("messenger_browser_clients").info("[pdb] cache dropped, out of date cache version"));s=!0;y=a},onLockReleased:function(){s=!1;return Promise.resolve()}}):null;i.debug("PDB is ON");d("LSPlatformLsInitLog").addPoint("init_idb_start");var w="mwChat-flushchanges-"+h+"-"+a,x=d("MWBroadcastChannel").MWBroadcastChannel(w),y=void 0,z=new Map(),A=c("nullthrows")((w=c("BrowserLockManager"))!=null?w:d("MessengerLocksManagerFallback")==null?void 0:d("MessengerLocksManagerFallback").make(c("uuidv4")().toString())),B=new Promise(function(b,c){void A.request(f,async function(){try{var d=await u(a,e,{worker3:!0},C);x.addEventListener("message",H);b(d)}catch(a){c(a)}})});c("promiseDone")(B.then(function(){d("LSPlatformLsInitLog").addPoint("init_idb_end")}));c("qex")._("403")&&c("promiseDone")(K(function(){return B.then(function(a){return t(a,z)})}));function C(a){a.close(),g=!1,v==null?void 0:v.release(),x.removeEventListener("message",H)}function D(a,b){return a.transaction(a.objectStoreNames,b,{durability:"relaxed"})}function E(a){var b=z.get(a);b==null&&(b=new Map(),z.set(a,b));return b}async function F(a){a===void 0&&(a=G);return(a=await a(function(a){return m(a.objectStore("_db_config").get("epoch"))}))==null?void 0:a.value}function G(a){function b(a){var b=D(a,"readonly");b.oncomplete=function(){j===b&&(j=null)};b.onabort=function(){j===b&&(j=null)};j=b}return new Promise(async function(c,d){o.push(function(b){return a(b).then(c)});var e=await B;if(j==null)try{b(e)}catch(a){d(a)}if(!p){p=!0;while(o.length){d=o;o=[];try{await Promise.all(d.map(function(a){return a(j)}))}catch(a){(a.name==="TransactionInactiveError"||a.name==="InvalidStateError")&&(b(e),await Promise.all(d.map(function(a){return a(j)})))}}p=!1}})}function H(a){a=a.data;var b=a.changeSet,d=a.fromVersion,e=a.sentinelDeleted;a=a.toVersion;if(s){c("FBLogger")("messenger_browser_clients").info("[pdb] unexpected cache update received after verifying cache matches db, ignoring");return}y!==d&&y!=null&&(z.clear(),c("FBLogger")("messenger_browser_clients").info("[pdb] out of order cache update received"));y=a;b.forEach(function(a,b){var c=E(b);a.forEach(function(a,b){a===e?c.delete(b):c.set(b,a)})})}async function I(){var a;if(!g)return;var b=(a=(a=await G(function(a){return r(a)}))==null?void 0:a.value)!=null?a:0;c("promiseDone")(B,async function(a){a=D(a,"readwrite");a=a.objectStore("_db_config");await m(a.put({name:d("MWLSIndexedDBConfigStore").dbCorruptionFailuresKey,value:b+1}))})}function J(){c("promiseDone")(B,function(a){C(a)})}async function K(a){await B;return v!=null?v.runExclusively(a):new Promise(function(b,d){void A.request(f,async function(){try{var e=await F();y!==e&&y!=null&&(z.clear(),c("FBLogger")("messenger_browser_clients").info("[pdb] cache dropped, out of date cache version"));y=e;s=!0;e=await a();s=!1;b(e)}catch(a){s=!1,d(a)}})})}return{clearCache:function(){z.clear()},close:J,flush:async function(b,e){e=e.upgrade;if(!g)return;var f=c("uuidv4")(),h=c("nullthrows")(y);async function i(a){var e=new Promise(function(e,g){a.oncomplete=function(a){try{x.postMessage({changeSet:b,fromVersion:h,sentinelDeleted:d("ReStorePersistence").sentinelDeleted,toVersion:f})}catch(a){c("recoverableViolation")("Failed to broadcast changes","messenger_web_product",a)}e(a.target.result)},a.onerror=a.onabort=function(a){y=null,z.clear(),g(a)}});if(c("gkx")("9005")){var g=await F(function(b){return b(a)});if(g!=null&&h!=null&&g!==h)throw c("FBLogger")("messenger_web_product").mustfixThrow("About to commit corruption due to cache version mismatch. Expected %s but got %s",h,g)}await Promise.all(Array.from(b).map(async function(b){var c=b[0];b=b[1];var e=a.objectStore(c);await Promise.all(Array.from(b).map(async function(a){var b=a[0];a=a[1];if(a===d("ReStorePersistence").sentinelDeleted)await m(e.delete(b));else{a=l(a,c);await m(e.put(a,b))}}))}));await m(a.objectStore("_db_config").put({name:"epoch",value:f}));await e}function k(){Array.from(b).forEach(function(a){var b=a[0];a=a[1];var c=E(b);Array.from(a).forEach(function(a){var b=a[0];a=a[1];a===d("ReStorePersistence").sentinelDeleted?c.delete(b):c.set(b,a)})}),y=f}if(n(b))return;var o=await B;if(e===!0){c("FBLogger")("messenger_browser_clients").info("[pdb] Updating IDB version, fromVersion: %s, non-empty tables: %s",o.version,Array.from(b.entries()).filter(function(a){a[0];a=a[1];return a.size>0}).map(function(a){a=a[0];return a}).sort().toString());(e=j)==null?void 0:e.abort();o.close();z.clear();y=null;B=async function(){var b=new(c("Deferred"))(),d=await q(a,function(a,d){k(),c("promiseDone")(i(d),function(){b.resolve()},function(){b.reject()})},C,o.version+1);await b.getPromise();return d}();await B;return}if(b.size===0)return;k();e=function(){return i(D(o,"readwrite"))};if(v!=null)return v.queueFlush(e);else await e()},get:function(a,b,c){var d=E(b);if(d.has(c))return d.get(c);else{if(!g)return new Promise(function(){});var e=G(function(a){return m(a.objectStore(b).get(c))}).then(function(a){var f=d.get(c);if(f!==e)return f;f=k(a,b);d.set(c,f);return f});d.set(c,e);return e}},logError:function(a,b,d,e){if(d==="dbCorruption"){b==="readwrite"&&c("promiseDone")(I());throw c("FBLogger")("messenger_web_product").mustfixThrow("Got unexpected undefined in pdb, mode: %s, table: %s, id: %s, deletedInThisTxn: %s",b,a,(d=e==null?void 0:e.id)!=null?d:"",(b=e==null?void 0:e.deletedInThisTxn)!=null?b:"")}},queueCommitWork:function(a){return v!=null?Promise.resolve(v.queueFlush(a)):a()},runExclusively:K,shouldApplySync:function(){return!0},shouldSync:function(a,b){return a==="notifyInMemoryTable"?!1:!0},types:["indexeddb"]}}a.schemaDiff=o;a.applyChanges=p;g.default=a}),98);
__d("IndexedDbStorage",["EBSMProperties","LSInMemoryTables","MAWLSVaultingHooks","ReStore","asyncToGeneratorRuntime","cr:6218","cr:6693","createReStoreEphemeralPersistenceForTables","createReStoreIndexedDbPersistence","createReStoreTableNameAllowListPersistence","justknobx"],(function(a,b,c,d,e,f,g){"use strict";var h=new Set([].concat(Array.from(d("LSInMemoryTables").all)));function i(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,d){a=c("createReStoreIndexedDbPersistence")(a,d);d=c("justknobx")._("440");var e;b("cr:6693")!=null&&(e=(yield b("cr:6693").makeEBStateDB()),c("EBSMProperties").persistedTables.forEach(function(a){return h.add(a)}));e==null&&(e=c("createReStoreEphemeralPersistenceForTables")());if(d)return c("createReStoreTableNameAllowListPersistence")(a,e,h);else return b("cr:6693")!=null?c("createReStoreTableNameAllowListPersistence")(a,e,c("EBSMProperties").persistedTables):a});return j.apply(this,arguments)}function a(a,b){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,d){a=(yield i(a,Object.keys(d.tableIds).map(function(a){return d.tableIds[Number(a)].name})));a=c("ReStore")(a,d,[c("MAWLSVaultingHooks")]);b("cr:6218")&&b("cr:6693")==null&&(yield b("cr:6218")(a));return a});return k.apply(this,arguments)}g["default"]=a}),98);
__d("MWLSIndexedDBName.bs",["MAWCurrentUser","MWLSDatabaseNames"],(function(a,b,c,d,e,f,g){"use strict";function a(){var a=d("MAWCurrentUser").getID();return d("MWLSDatabaseNames").lightspeedPrefix+a}g.dbName=a}),98);
__d("MWLSIndexedDBDelete.bs",["MWLSIndexedDBName.bs","ODS","recoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){try{var e=d("MWLSIndexedDBName.bs").dbName();e=indexedDB.deleteDatabase(e);e.onerror=function(){d("ODS").bumpEntityKey(3185,"db_delete","error."+a),c("recoverableViolation")("[pdb] Failed to delete db","messenger_web_product")};e.onblocked=function(){d("ODS").bumpEntityKey(3185,"db_delete","block."+a)};e.onsuccess=function(){d("ODS").bumpEntityKey(3185,"db_delete","success."+a);if(b!=null)return b()};return}catch(a){c("recoverableViolation")("[pdb] error in db deletion ","messenger_web_product");return}}g.deleteIndexedDB=a}),98);
__d("MWLSSchemaIndexedDB",["IndexedDbStorage","LSMetadata","LSPlatformLsInitLog","MWLSIndexedDBDelete.bs","MWLSIndexedDBName.bs","MWSetupDBEncryption","MessengerLogHistory","asyncToGeneratorRuntime","recoverableViolation"],(function(a,b,c,d,e,f,g){"use strict";var h=d("MessengerLogHistory").getInstance("db_init"),i=typeof window!=="undefined"?window:self,j=i==null?void 0:(i=i.navigator)==null?void 0:i.locks;function a(){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){d("LSPlatformLsInitLog").addPoint("init_start");h.debug("Creating persistence");var a=(yield c("IndexedDbStorage")(d("MWLSIndexedDBName.bs").dbName(),d("LSMetadata").metadata));h.debug("Persistence created");d("LSPlatformLsInitLog").addPoint("init_end");return a});return k.apply(this,arguments)}function e(a,b){try{b.closeDb(),d("MWLSIndexedDBDelete.bs").deleteIndexedDB(a)}catch(a){c("recoverableViolation")("[pdb] Cannot delete db","messenger_web_product")}}function f(){return l.apply(this,arguments)}function l(){l=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(j==null)return!1;h.debug("Creating EAR");var a=(yield d("MWSetupDBEncryption").init());if(!a.success){h.debug("EAR failed, PDB is OFF.");return!1}h.debug("EAR created");return!0});return l.apply(this,arguments)}g.createDB=a;g.deleteDB=e;g.isSupported=f}),98);
__d("LSPlatformLogout",["LSCookie","LSDatabaseSingleton","Promise","QPLUserFlow","asyncToGeneratorRuntime","cr:5773","qpl","react"],(function(a,b,c,d,e,f,g){"use strict";var h=d("react").useCallback;function i(){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(!b("cr:5773"))return;c("QPLUserFlow").start(c("qpl")._(25311266,"236"),{cancelOnUnload:!0,timeoutInMs:3e3});try{yield b("Promise").all([b("asyncToGeneratorRuntime").asyncToGenerator(function*(){var a=(yield c("LSDatabaseSingleton"));b("cr:5773").deleteDB("logout",a)})(),d("LSCookie").deleteCookie()])}catch(a){c("QPLUserFlow").endFailure(c("qpl")._(25311266,"236"),"fail");return}c("QPLUserFlow").endSuccess(c("qpl")._(25311266,"236"))});return j.apply(this,arguments)}function a(){return h(i,[])}g.logout=i;g.useLogout=a}),98);